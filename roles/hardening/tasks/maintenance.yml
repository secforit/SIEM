---
# ============================================================
# CIS 6.x - System Maintenance
# ============================================================

# --- 6.1 System File Permissions ---
- name: "CIS 6.1.1 | Ensure permissions on /etc/passwd"
  ansible.builtin.file:
    path: /etc/passwd
    owner: root
    group: root
    mode: "0644"

- name: "CIS 6.1.2 | Ensure permissions on /etc/shadow"
  ansible.builtin.file:
    path: /etc/shadow
    owner: root
    group: shadow
    mode: "0640"

- name: "CIS 6.1.3 | Ensure permissions on /etc/group"
  ansible.builtin.file:
    path: /etc/group
    owner: root
    group: root
    mode: "0644"

- name: "CIS 6.1.4 | Ensure permissions on /etc/gshadow"
  ansible.builtin.file:
    path: /etc/gshadow
    owner: root
    group: shadow
    mode: "0640"

- name: "CIS 6.1.5 | Ensure permissions on /etc/passwd-"
  ansible.builtin.file:
    path: /etc/passwd-
    owner: root
    group: root
    mode: "0600"
  failed_when: false

- name: "CIS 6.1.6 | Ensure permissions on /etc/shadow-"
  ansible.builtin.file:
    path: /etc/shadow-
    owner: root
    group: shadow
    mode: "0600"
  failed_when: false

# --- 6.2 Ensure no duplicate UIDs/GIDs/usernames ---
- name: "CIS 6.2.x | Audit for duplicate entries"
  ansible.builtin.shell: |
    echo "=== Duplicate UIDs ===" && \
    awk -F: '{print $3}' /etc/passwd | sort | uniq -d && \
    echo "=== Duplicate GIDs ===" && \
    awk -F: '{print $3}' /etc/group | sort | uniq -d && \
    echo "=== Duplicate usernames ===" && \
    awk -F: '{print $1}' /etc/passwd | sort | uniq -d
  register: duplicate_check
  changed_when: false

- name: "CIS 6.2.x | Report duplicate findings"
  ansible.builtin.debug:
    msg: "{{ duplicate_check.stdout_lines }}"

# --- 6.3 Ensure no users have .forward or .rhosts files ---
- name: "CIS 6.3 | Remove dangerous dot files from home dirs"
  ansible.builtin.shell: |
    for dir in $(awk -F: '($3 >= 1000) {print $6}' /etc/passwd); do
      rm -f "$dir/.forward" "$dir/.rhosts" "$dir/.netrc" 2>/dev/null
    done
  changed_when: false
  failed_when: false
