---
# ============================================================
# Filebeat Installation (Wazuh events -> Indexer)
# ============================================================

- name: Install Filebeat
  ansible.builtin.apt:
    name: "filebeat={{ filebeat_version }}"
    state: present
    allow_downgrade: true
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Download Filebeat Wazuh module
  ansible.builtin.get_url:
    url: "https://packages.wazuh.com/4.x/filebeat/wazuh-filebeat-0.4.tar.gz"
    dest: /tmp/wazuh-filebeat-0.4.tar.gz
    mode: "0644"

- name: Install Filebeat Wazuh module
  ansible.builtin.unarchive:
    src: /tmp/wazuh-filebeat-0.4.tar.gz
    dest: /usr/share/filebeat/module
    remote_src: true
    creates: /usr/share/filebeat/module/wazuh

- name: Configure Filebeat
  ansible.builtin.template:
    src: filebeat.yml.j2
    dest: /etc/filebeat/filebeat.yml
    owner: root
    group: root
    mode: "0644"
  notify: restart filebeat

- name: Download Wazuh alerts template
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/wazuh/wazuh/v{{ wazuh_version }}/extensions/elasticsearch/7.x/wazuh-template.json"
    dest: /etc/filebeat/wazuh-template.json
    mode: "0644"
  failed_when: false

- name: Deploy Filebeat certificates
  ansible.builtin.shell: |
    mkdir -p /etc/filebeat/certs
    tar -xzf /tmp/wazuh-certificates.tar.gz -C /etc/filebeat/certs/ \
      wazuh-certificates/{{ wazuh_indexer_node_name }}.pem \
      wazuh-certificates/{{ wazuh_indexer_node_name }}-key.pem \
      wazuh-certificates/root-ca.pem --strip-components=1
    chmod 500 /etc/filebeat/certs
    chmod 400 /etc/filebeat/certs/*
  args:
    creates: /etc/filebeat/certs/root-ca.pem

- name: Enable and start Filebeat
  ansible.builtin.systemd:
    name: filebeat
    state: started
    enabled: true
    daemon_reload: true
